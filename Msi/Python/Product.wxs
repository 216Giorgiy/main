<?xml version="1.0" encoding="UTF-8"?>

<!--
  IronPython installer root features, upgrades, and product definition
  2006-01-01 BobArnso Created
-->

<!-- 
WHEN PERFORMING MAJOR IP UPGRADES (e.g., 2.5 => 2.6):
1. Update the UpgradeCode GUID
2. Check that the IronPython "ARP*" property links are still valid
-->

<?include Version.wxi ?> 

<?define OldUpgradeCode = "a162604e-d515-4155-9b8b-2854502d1588" ?>
<?define UpgradeCode = "{2C059D95-EB2E-4359-8605-51415DD898C4}" ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" UpgradeCode="$(var.UpgradeCode)" Name="$(var.ProductShortName) $(var.ProductVersionText)" Version="$(var.ProductVersion)" Language="1033" Manufacturer="$(var.Manufacturer)">
    <Package Id="*" Compressed="yes" Description="$(var.ProductShortName) $(var.ProductVersionText) ($(var.ProductVersion))" InstallerVersion="200" ShortNames="no" Manufacturer="$(var.Manufacturer)" />
    <Media Id="1" Cabinet="IronPy.cab" EmbedCab="yes" CompressionLevel="high" />
    
    <!-- Major upgrade -->
    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion Minimum="$(var.ProductVersion)" OnlyDetect="yes" Property="NEWERVERSIONDETECTED" />
      <UpgradeVersion Minimum="$(var.ReleaseSeries).0" IncludeMinimum="yes" Maximum="$(var.ProductVersion)" IncludeMaximum="no" Property="OLDERVERSIONBEINGUPGRADED" OnlyDetect="no" />
    </Upgrade>

    <!-- The upgrade code should have changed for 2.7 but didn't. This allows upgrading 2.7 versions while not upgrading 2.6 versions. -->
    <Upgrade Id="$(var.OldUpgradeCode)">
      <UpgradeVersion Minimum="$(var.ReleaseSeries).0" IncludeMinimum="yes" Maximum="$(var.ProductVersion)" IncludeMaximum="no" Property="BADUPGRADEVERSIONBEINGUPGRADED" OnlyDetect="no" />
    </Upgrade>

    <!-- Properties -->
    <Property Id="ALLUSERS" Value="1" />
    <Property Id="ARPHELPLINK" Value="http://ironpython.net/support/" />
    <Property Id="ARPURLINFOABOUT" Value="http://www.ironpython.net" />
    <Property Id="ARPURLUPDATEINFO" Value="http://ironpython.codeplex.com" />

    <!-- We search for an existing file type for .py files.  If it's found we'll use it, otherwise we'll default to Python.File which matches CPython -->
    <Property Id="PYTHONFILETYPE" Value="Python.File">
      <RegistrySearch Id="PythonFileTypeSearch" Root="HKCR" Key=".py" Type="raw" />
    </Property>

    <!-- Same thing but used to decide if we should install the default info for the file type -->
    <Property Id="PYTHONFILETYPENODEFAULT" >
      <RegistrySearch Id="PythonFileTypeNoDefaultSearch" Root="HKCR" Key=".py" Type="raw" />
    </Property>

    <!-- Launch conditions -->
    <Condition Message="An administrator must approve or install [ProductName]."> Privileged </Condition>
    <Condition Message="A later version of [ProductName] is already installed."> NOT NEWERVERSIONDETECTED </Condition>
    <Condition Message="[ProductName] requires .NET Framework 4.0 or later.">  Installed OR MsiNetAssemblySupport >= "4.0.0.0" </Condition>

    <!-- Root directories -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramMenuFolder" Name="PMENU" />

      <Directory Id="ProgramFilesFolder" Name="PFILES">
        <Directory Id="INSTALLDIR" Name="$(var.ProductShortName) $(var.ReleaseSeries)" />
      </Directory>

      <Directory Id="GAC" Name="GAC" />
    </Directory>

    <!--<DirectoryRef Id="ProgramMenuFolder">
      <Directory Id="Dir_StartMenu" Name="$(var.ProductShortName) $(var.ProductVersionText)">
        <Component Id="Comp_CompiledHelpShortcut" DiskId="1" Guid="F398FAC1-F78F-4A22-A91A-3BC455556224">
          <Shortcut Id="Shortcut_CompiledHelp" Directory="Dir_StartMenu" Name="IronPython Documentation" Target="[#File_IronPython.chm]" />
          <Shortcut Id="Shortcut_Readme" Directory="Dir_StartMenu" Name="IronPython Readme" Target="[#File_Readme.html.B25C469D_12C7_4327_AEF1_B2D3505E115E]" />
          <Shortcut Id="NGENShortcut_Console" Directory="Dir_StartMenu" Name="IronPython Console" Target="[#NGENFile_ipy.exe.B25C469D_12C7_4327_AEF1_B2D3505E115E]" />
          <Shortcut Id="NGEN64Shortcut_Console" Directory="Dir_StartMenu" Name="IronPython Console" Target="[#NGEN64File_ipy.exe.B25C469D_12C7_4327_AEF1_B2D3505E115E]" />
          <Shortcut Id="NGEN6464Shortcut_Console" Directory="Dir_StartMenu" Name="IronPython 64-bit Console" Target="[#NGEN64File_ipy64.exe.B25C469D_12C7_4327_AEF1_B2D3505E115E]" />

          <RemoveFolder Id='Comp_ReadMe' On='uninstall'/>
          <RegistryValue Root='HKCU' Key='SOFTWARE\IronPython\2.7\Docs' Type='string' Value='Installed' KeyPath='yes' />
        </Component>
      </Directory>
    </DirectoryRef>-->

    <DirectoryRef Id='INSTALLDIR'>
      <!--<Merge Id='DLR' Language='1033' src='DLR.msm' DiskId='1' />
      <Merge Id='IpyRedist' Language='1033' src='$(var.TargetDir)\IpyRedist.msm' DiskId='1' />
      <Merge Id='IronStudio' Language='1033' src='IronStudio.msm' DiskId='1' />-->

      <!-- CHM file for documentation -->
      <!--<Component Id="Comp_CompiledHelp" DiskId="1" Guid="61369245-1BC0-4699-93F7-C206BE678A92">
        <File Id="File_IronPython.chm" Name="IronPython.chm" Source="$(var.TargetDir)IronPython.chm" />
      </Component>-->

      <!--<Directory Id="Dir_Silverlight" Name="Silverlight">
        <?include Silverlight.wxi ?>
      </Directory>-->
    </DirectoryRef>
    
    <!-- Features - listed in the UI in the same order as they appear here -->
    <Feature Id="Feature_IronPython" ConfigurableDirectory="INSTALLDIR" Absent="disallow" AllowAdvertise="no" Display="expand" Level="1" Title="IronPython">
      <Feature Id="Feature_Core" Absent="disallow" AllowAdvertise="no" Level="1" Title="IronPython" Description="IronPython binaries for the Desktop CLR.">
        <ComponentGroupRef Id='Dlr' />
        <ComponentGroupRef Id='IronPython' />

        <!--<ComponentGroupRef Id="DocGroup" Primary="yes"/>
        <ComponentRef Id="Comp_CompiledHelp" Primary="yes" />
        <ComponentRef Id="Comp_CompiledHelpShortcut" Primary="yes" />-->
      </Feature>

      <!-- Silverlight support -->
      <!--<Feature Id="Feature_SL" AllowAdvertise="no" Level="1" Title="Silverlight Support" Description="IronPython for Silverlight.">
        <Feature Id="Feature_SL_Binaries" AllowAdvertise="no" Level="1" Title="Binaries" Description="IronPython binaries targeting Silverlight.">
          <ComponentRef Id="Comp_SL" />
        </Feature>
        <Feature Id="Feature_SLTemplates" AllowAdvertise="no" Level="1" Title="Templates" Description="Templates supporting IronPython Silverlight development.">
          <ComponentRef Id="Comp_SLScript" />
          <ComponentRef Id="Comp_templHome" />
          <ComponentRef Id="Comp_templPy" />
          <ComponentRef Id="Comp_templJS" />
          <ComponentRef Id="Comp_templSS" />
        </Feature>
      </Feature>-->
      
      <!--<Feature Id="Feature_Tools" AllowAdvertise="no" Level="1" Title="Scripts" Description="Some useful scripts that have been written for IronPython.">
        <ComponentGroupRef Id="ToolsGroup" Primary="yes"/>
      </Feature>-->
      
      <!--<Feature Id="Feature_Tutorial" AllowAdvertise="no" Level="1" Title="Tutorial" Description="IronPython Tutorial">
        <ComponentRef Id="Comp_Tutorial" />
        <ComponentRef Id="Comp_Extend" />
      </Feature>-->
    </Feature>

    <!-- Sequences -->
    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallInitialize"  />
      <Custom Action='SetInstallLocation' After="InstallValidate" />
    </InstallExecuteSequence>

    <InstallUISequence>
      <!-- Because we have a launch condition that uses the results of FindRelatedProducts, put it first. -->
      <LaunchConditions After="FindRelatedProducts" />
    </InstallUISequence>

    <!-- User interface -->
    <UIRef Id="WixUI_FeatureTree" />
    <WixVariable Id="WixUILicenseRtf" Value="$(var.StageDir)\License.rtf" /> 

    <!-- InstallLocation key -->
    <CustomAction Id="SetInstallLocation" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />

  </Product>

</Wix>